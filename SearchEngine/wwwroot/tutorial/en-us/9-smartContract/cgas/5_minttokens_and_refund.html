<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="robots" content="index,follow">
    <meta name="author" content="neo-project">
    <meta name="application-name" content="neo.org">
    <meta name="renderer" content="ie-stand">
    <title>MintTokens and Refund</title>
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Neo Documentation" />
    <meta property="og:description" content="Neo Documentation" />
    <meta property="og:image" content="/img/twitter-img.jpg" />
    <meta name="twitter:title" content="Neo Documentation" />
    <meta name="twitter:description" content="Neo Documentation" />
    <meta name="twitter:image" content="/img/twitter-img.jpg" />
    <meta name="twitter:card" content="summary_large_image" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
    <link rel="manifest" href="/img/site.webmanifest">
    <link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#ffffff">

    <link href="https://neo-cdn.azureedge.net/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://neo-cdn.azureedge.net/lib/animate.css/animate.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/default.min.css">
    <link href="/lib/font-awesome/css/all.min.css" rel="stylesheet" />
    <link href="/css/site.min.css" rel="stylesheet" />
</head>
<body data-spy="scroll" data-target="#navbar-sidenav">
    <nav class="navbar fixed-top navbar-expand-lg py-1 px-3 px-sm-4 px-md-5">
        <a class="navbar-brand" href="https://neo.org">
            <img class="logo" src="/img/logo.svg" alt="NEO Logo" />
            <img class="logo-dark" src="/img/logo-dark.svg" alt="NEO Logo" />
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/docs">Documentation</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/tutorial">Tutorial</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/faq">FAQ</a>
                </li>
                <li class="nav-item" style="margin-right: 100px">
                    <a class="nav-link" href="/articles">Articles</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link d-inline-block" href="javascript:" onclick="language('en-us')">EN</a>|<a class="nav-link d-inline-block" href="javascript:" onclick="language('zh-cn')">中文</a>
                </li>
            </ul>
            <form class="form-inline my-2 my-lg-0 d-none">
                <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
            </form>
        </div>
    </nav>
    <div class="container-fluid" style="margin-top: 55px">
        <div class="row d-flex">
            <div class="d-none d-md-block catalog py-2 py-md-5 pl-md-3">
                
<nav class='nav nav-pills flex-column ml-3'>
<span class='ml-0 my-1 nav-link'><i class='fas fa-caret-right'></i>Introduction to NEO</span>
<nav class='nav nav-pills flex-column ml-3'>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/1-introduction/1-Introduction_to_NEO.html'>Introduction</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/1-introduction/2-Cryptography_Blockchain_and_Smart_Contracts.html'>Cryptography, Blockchain, and Smart Contracts</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/1-introduction/3-Fundamentals_of_NEO.html'>NEO Fundamentals</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/1-introduction/resource.html'>Additional Resources</a>
</nav>
<span class='ml-0 my-1 nav-link'><i class='fas fa-caret-right'></i>Wallet</span>
<nav class='nav nav-pills flex-column ml-3'>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/2-wallet/1-Introduction_to_wallets.html'>Introduction</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/2-wallet/2-Key_derivation_and_address_generation_on_NEO.html'>Keys and Addresses</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/2-wallet/3-Key_encryption_and_contract_accounts.html'>Private key encryption and Wallet files</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/2-wallet/4-UTXO_and_account_models.html'>The UTXO and Account models</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/2-wallet/resource.html'>Additional Resources</a>
</nav>
<span class='ml-0 my-1 nav-link'><i class='fas fa-caret-right'></i>Transactions</span>
<nav class='nav nav-pills flex-column ml-3'>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/3-transactions/1-Introduction_to_transactions.html'>Introduction</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/3-transactions/2-Structure_of_NEO_transactions.html'>Structure of NEO transactions</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/3-transactions/3-NEO_transaction_types.html'>NEO transaction types</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/3-transactions/4-NEO_transaction_fees.html'>Transaction fees</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/3-transactions/resource.html'>Additional Resources</a>
</nav>
<span class='ml-0 my-1 nav-link'><i class='fas fa-caret-right'></i>Blocks</span>
<nav class='nav nav-pills flex-column ml-3'>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/4-blocks/1-Introduction_to_blocks_and_blockchain.html'>Introduction</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/4-blocks/2-Structure_of_a_block.html'>Structure of a Block</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/4-blocks/3-Block_creation_broadcasting.html'>Block Creation and Broadcasting</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/4-blocks/4-Block_validation_processing.html'>Block Validation and Processing</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/4-blocks/resource.html'>Additional Resources</a>
</nav>
<span class='ml-0 my-1 nav-link'><i class='fas fa-caret-right'></i>Network</span>
<nav class='nav nav-pills flex-column ml-3'>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/5-network/1-Introduction_to_the_NEO_network_protocol.html'>NEO Network and Protocol</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/5-network/resource.html'>Additional Resources</a>
</nav>
<span class='ml-0 my-1 nav-link'><i class='fas fa-caret-right'></i>Persistence</span>
<nav class='nav nav-pills flex-column ml-3'>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/6-persistence/1-persistence.html'>Introduction</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/6-persistence/2-levelDB_data_structure.html'>Developing a NEO Ping using Golang</a>
</nav>
<span class='ml-0 my-1 nav-link'><i class='fas fa-caret-right'></i>Consensus</span>
<nav class='nav nav-pills flex-column ml-3'>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/7-consensus/1-Introduction_to_consensus.html'>Introduction</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/7-consensus/2-Proof_of_work_and_proof_of_stake.html'>PoW and PoS</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/7-consensus/3-PBFT_and_DBFT.html'>pBFT and dBFT</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/7-consensus/4-Examples_and_consensus_scenarios_for_dBFT.html'>dBFT Consensus Examples and Scenarios</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/7-consensus/resource.html'>Additional Resources</a>
</nav>
<span class='ml-0 my-1 nav-link'><i class='fas fa-caret-right'></i>Smart Contract</span>
<nav class='nav nav-pills flex-column ml-3'>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/What_is_smart_contract.html'>Introduction</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/Development_privateChain.html'>Setting up a Private Chain</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/Development_set_up.html'>Setting up Development Enviroment</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/Development_compile.html'>Contract Invoking and Deployment</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/Smart_Contract_basics.html'>Smart Contract Basics</a>
<span class='ml-0 my-1 nav-link'><i class='fas fa-caret-right'></i>Make your NEP-5 Token</span>
<nav class='nav nav-pills flex-column ml-3'>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/What_is_nep5.html'>Introduction to NEP-5</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/Implementation_of_NEP5.html'>Implementation of NEP-5</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/Give_an_ITO.html'>ITO(Initial Token Offering)</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/UTXO.html'>UTXO basics</a>
</nav>
<span class='ml-0 my-1 nav-link'><i class='fas fa-caret-right'></i>CGAS</span>
<nav class='nav nav-pills flex-column ml-3'>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/cgas/1_what_is_cgas.html'>What is CGAS</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/cgas/2_global_asset_and_nep5.html'>Global asset and NEP-5</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/cgas/3_utxo_model.html'>UTXO model</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/cgas/4_trigger.html'>Trigger</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/cgas/5_minttokens_and_refund.html'>Mint and Refund</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/cgas/6_signature_and_verification.html'>Signature and Verification</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/cgas/7_invocation.html'>Transaction Invocation</a>
</nav>
<span class='ml-0 my-1 nav-link'><i class='fas fa-caret-right'></i>Write NEO smart contract with Python</span>
<nav class='nav nav-pills flex-column ml-3'>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/neopython/part1_setup.html'>Installing and Setting up the Environment</a>
<a class='ml-0 my-1 nav-link' href='/tutorial/en-us/9-smartContract/neopython/part2_neopy.html'>Wallet Operations and Smart Contracts</a>
</nav>
</nav>
</nav>
            </div>
            <main class="p-3 p-sm-4 p-md-5">
                <a class="d-block d-md-none" href="javascript:" onclick="showCatalog()">Show / Hide Table of Contents</a>
                <h1 id='c3dcc34c'><span class='with-space bd-content-title'>MintTokens and Refund<a class='anchorjs-link ' href='#c3dcc34c' aria-label='Anchor' data-anchorjs-icon='#'></a></span></h1>
<h2 id='b40b6db7'><span class='with-space bd-content-title'>Part of the code for MintTokens<a class='anchorjs-link ' href='#b40b6db7' aria-label='Anchor' data-anchorjs-icon='#'></a></span></h2>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='var tx = ExecutionEngine.ScriptContainer as Transaction;
byte[] sender = null;
var inputs = tx.GetReferences();
foreach (var input in inputs)
{
    if (input.AssetId.AsBigInteger() == AssetId.AsBigInteger())
        sender = sender ?? input.ScriptHash;
    if (input.ScriptHash.AsBigInteger() == ExecutionEngine.ExecutingScriptHash.AsBigInteger())
        return false;
}'>Copy</button><pre><code class='csharp' lang='csharp'>var tx = ExecutionEngine.ScriptContainer as Transaction;
byte[] sender = null;
var inputs = tx.GetReferences();
foreach (var input in inputs)
{
    if (input.AssetId.AsBigInteger() == AssetId.AsBigInteger())
        sender = sender ?? input.ScriptHash;
    if (input.ScriptHash.AsBigInteger() == ExecutionEngine.ExecutingScriptHash.AsBigInteger())
        return false;
}
</code></pre>
</figure>
<p class='with-space'>These first few lines are to get the user who initiates MintTokens, namely the investor. But investors are not allowed to be CGAS, otherwise it’s possible to use this vulnerability to attack.</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='if (GetTxInfo(tx.Hash) != null)
    return false;'>Copy</button><pre><code class='csharp' lang='csharp'>if (GetTxInfo(tx.Hash) != null)
    return false;
</code></pre>
</figure>
<p class='with-space'>The next line is also to prevent hackers, and works with the end code of MintTokens.</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='SetTxInfo(null, sender, value);'>Copy</button><pre><code class='csharp' lang='csharp'>SetTxInfo(null, sender, value);
</code></pre>
</figure>
<p class='with-space'>Normally an Invocation transaction will execute the Main method once, and so does a invocation through the NEO-GUI. But if a hacker manually constructs a transaction to execute the Main method multiple times and each time invoke MintTokens, it will lead to multiple token-mint operations for a single investment. Such attack can be avoided in this way. After a MintTokens method is executed, the transaction ID is written in the storage area. Every time the MintTokens is executed, return false if the transaction ID is found in the storage area, indicating it an invalid MintTokens operation.</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='var outputs = tx.GetOutputs();
ulong value = 0;
foreach (var output in outputs)
{
    if (output.ScriptHash == ExecutionEngine.ExecutingScriptHash &amp;&amp;
        output.AssetId.AsBigInteger() == AssetId.AsBigInteger())
    {
        value += (ulong)output.Value;
    }
}'>Copy</button><pre><code class='csharp' lang='csharp'>var outputs = tx.GetOutputs();
ulong value = 0;
foreach (var output in outputs)
{
    if (output.ScriptHash == ExecutionEngine.ExecutingScriptHash &amp;&amp;
        output.AssetId.AsBigInteger() == AssetId.AsBigInteger())
    {
        value += (ulong)output.Value;
    }
}
</code></pre>
</figure>
<p class='with-space'>The following code is to calculate the amount of GAS transferred to the CGAS contract. All transaction outputs are traversed here. If the transferred address is a CGAS address and the transferred asset is GAS, then the corresponding amount is counted.</p>
<p class='with-space'>Once getting the total amount of GAS transferred by the user to the CGAS contract, we need to perform the next two operations:</p>
<ol>
<li>
<p class='with-space'>Modify the total amount of CGAS</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='StorageMap contract =        Storage.CurrentContext.CreateMap(nameof(contract)); 
var totalSupply = contract.Get(&quot;totalSupply&quot;).AsBigInteger(); 
totalSupply += value; 
contract.Put(&quot;totalSupply&quot;, totalSupply); '>Copy</button><pre><code class='csharp' lang='csharp'>StorageMap contract =        Storage.CurrentContext.CreateMap(nameof(contract)); 
var totalSupply = contract.Get(&quot;totalSupply&quot;).AsBigInteger(); 
totalSupply += value; 
contract.Put(&quot;totalSupply&quot;, totalSupply); 
</code></pre>
</figure></li>
<li>
<p class='with-space'>Distribute CGAS to the user according to the exchange proportion</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='StorageMap asset = Storage.CurrentContext.CreateMap(nameof(asset)); 
var amount = asset.Get(sender).AsBigInteger(); 
asset.Put(sender, amount + value); '>Copy</button><pre><code class='csharp' lang='csharp'>StorageMap asset = Storage.CurrentContext.CreateMap(nameof(asset)); 
var amount = asset.Get(sender).AsBigInteger(); 
asset.Put(sender, amount + value); 
</code></pre>
</figure></li>
</ol>
<p class='with-space'>Finally, transfer event is triggered to notify the client to make a transfer to the user out of nowhere, that is, to distribute the asset.</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='Transferred(null, sender, value);'>Copy</button><pre><code class='csharp' lang='csharp'>Transferred(null, sender, value);
</code></pre>
</figure>
<p class='with-space'>There are three parameters in Transferred method, namely sender, receiver, and transferred amount. In MintTokens, the sender is null, and in the first step of the refund, the receiver is null.</p>
<p class='with-space'>Additional fees are allowed for users in MintTokens. The code only checks the GAS part of the transaction outputs transferred to the CGAS contract. The GAS included in the user’s transaction inputs and the changed GAS is not counted.</p>
<h2 id='d533adaa'><span class='with-space bd-content-title'>Part of the code for Refund<a class='anchorjs-link ' href='#d533adaa' aria-label='Anchor' data-anchorjs-icon='#'></a></span></h2>
<p class='with-space'>Recall the introduction in the method description: Users exchange CGAS to GAS in two steps. The first step is to initiate an InvocationTransaction, which contains a GAS transferred from the CGAS address to the CGAS address (the transfer amount is the amount of GAS the user want to refund), and invoke the refund method (parameter is the refunder&#39;s Script Hash). When the contract invocation is successful, the CGAS equal to the refunded amount will be automatically ruined, and the output with index 0 of the transaction will be marked as belonging to the user. In the second step, the user creates a transaction that takes the UTXO marked in the first step as the transaction input and own address as output, thus taking the GAS from the CGAS address.</p>
<p class='with-space'>So which step does this part of the refund method correspond to?</p>
<p class='with-space'>Obviously, the refund is invoked in the Application trigger in the Main method, so only InvocationTransaction can trigger the method. The corresponding step is to execute refund method after the success of the transaction in the first step.</p>
<p class='with-space'>In the code, there are two sections of code that jointly complete the first step of the Refund, one is the code for Verification trigger mentioned above, and the other is the code for refund method.</p>
<p class='with-space'>This code is executed after the InvocationTransaction has been successfully verified.</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='if (from.Length != 20)
    throw new InvalidOperationException(&quot;The parameter from SHOULD be 20-byte addresses.&quot;);'>Copy</button><pre><code class='csharp' lang='csharp'>if (from.Length != 20)
    throw new InvalidOperationException(&quot;The parameter from SHOULD be 20-byte addresses.&quot;);
</code></pre>
</figure>
<p class='with-space'>The first is to verify the parameters, which is in line with the NEP-5 specification. The transfer is proceeding from CGAS address to CGAS address, and no user address is involved. So in order to get the user&#39;s address, it is required to take it as a parameter in the input.</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='var tx = ExecutionEngine.ScriptContainer as Transaction;
var preRefund = tx.GetOutputs()[0];
if (preRefund.AssetId.AsBigInteger() != AssetId.AsBigInteger()) return false;'>Copy</button><pre><code class='csharp' lang='csharp'>var tx = ExecutionEngine.ScriptContainer as Transaction;
var preRefund = tx.GetOutputs()[0];
if (preRefund.AssetId.AsBigInteger() != AssetId.AsBigInteger()) return false;
</code></pre>
</figure>
<p class='with-space'>Then the invalidity of the Refund asset is verified.</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='if (preRefund.ScriptHash.AsBigInteger() != ExecutionEngine.ExecutingScriptHash.AsBigInteger()) return false;'>Copy</button><pre><code class='csharp' lang='csharp'>if (preRefund.ScriptHash.AsBigInteger() != ExecutionEngine.ExecutingScriptHash.AsBigInteger()) return false;
</code></pre>
</figure>
<p class='with-space'>Next, we are going to mark the transaction output with index 0 as refund, so first we need to verify whether the transaction output refers to the CGAS address rather than the other address.</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='StorageMap refund = Storage.CurrentContext.CreateMap(nameof(refund));
if (refund.Get(tx.Hash).Length &gt; 0) return false;
……
refund.Put(tx.Hash, from);'>Copy</button><pre><code class='csharp' lang='csharp'>StorageMap refund = Storage.CurrentContext.CreateMap(nameof(refund));
if (refund.Get(tx.Hash).Length &gt; 0) return false;
……
refund.Put(tx.Hash, from);
</code></pre>
</figure>
<p class='with-space'>This step is preventive programming to prevent the same UTXO from being refunded multiple times, which will lead to the loss of user’s assets.</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='if (!Runtime.CheckWitness(from)) return false;'>Copy</button><pre><code class='csharp' lang='csharp'>if (!Runtime.CheckWitness(from)) return false;
</code></pre>
</figure>
<p class='with-space'>The final step is to verify the signature, which is a common means for permission verification. If the hacker wants to refund other people&#39;s assets, parameter from will be filled as others’ address. At this point, the verification will fail.</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='StorageMap asset = Storage.CurrentContext.CreateMap(nameof(asset));
var fromAmount = asset.Get(from).AsBigInteger();
var preRefundValue = preRefund.Value;
if (fromAmount &lt; preRefundValue)
    return false;
else if (fromAmount == preRefundValue)
    asset.Delete(from);
else
    asset.Put(from, fromAmount - preRefundValue);'>Copy</button><pre><code class='csharp' lang='csharp'>StorageMap asset = Storage.CurrentContext.CreateMap(nameof(asset));
var fromAmount = asset.Get(from).AsBigInteger();
var preRefundValue = preRefund.Value;
if (fromAmount &lt; preRefundValue)
    return false;
else if (fromAmount == preRefundValue)
    asset.Delete(from);
else
    asset.Put(from, fromAmount - preRefundValue);
</code></pre>
</figure>
<p class='with-space'>Once the verification of the identity, it’s ready to operate the user’s assets. It is about to reduce the user&#39;s assets. In order to avoid negative numbers, we first compare the refund amount with the user’s balance, and then modify the user assets.</p>
<p class='with-space'>If the user&#39;s assets are reduced, then the total amount of CGAS will also be reduced, so the totalSupply should be modified as follows:</p>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='StorageMap contract = Storage.CurrentContext.CreateMap(nameof(contract));
var totalSupply = contract.Get(&quot;totalSupply&quot;).AsBigInteger();
totalSupply -= preRefundValue;
contract.Put(&quot;totalSupply&quot;, totalSupply);'>Copy</button><pre><code class='csharp' lang='csharp'>StorageMap contract = Storage.CurrentContext.CreateMap(nameof(contract));
var totalSupply = contract.Get(&quot;totalSupply&quot;).AsBigInteger();
totalSupply -= preRefundValue;
contract.Put(&quot;totalSupply&quot;, totalSupply);
</code></pre>
</figure>
<figure class='highlight'>
<button type='button' class='btn-clipboard' data-original-title='Copy to clipboard' data-clipboard-action='copy' data-toggle='tooltip' data-placement='top' title='Copy to clipboard' data-clipboard-text='SetTxInfo(from, null, preRefundValue);
Transferred(from, null, preRefundValue);
Refunded(tx.Hash, from);'>Copy</button><pre><code class='csharp' lang='csharp'>SetTxInfo(from, null, preRefundValue);
Transferred(from, null, preRefundValue);
Refunded(tx.Hash, from);
</code></pre>
</figure>
<p class='with-space'>Finally, the transaction ID is recorded to facilitate query and trigger Transferred event for the convenience of blockchain explorer and client processing. Then record the refunder of the UTXO to prepare for the second step of the refund.</p>
<h2 id='c7f5ef62'><span class='with-space bd-content-title'>Next Step<a class='anchorjs-link ' href='#c7f5ef62' aria-label='Anchor' data-anchorjs-icon='#'></a></span></h2>
<p class='with-space'>Now let us move to the <a href='6_signature_and_verification.html'> signature and verification</a> </p>
<p class='with-space'>To learn the function of trigger, click <a href='4_trigger.html'> here</a> </p>
            </main>
            <div class="d-none d-lg-block side-nav py-2 py-md-5">
                <a href="https://github.com/neo-project/docs/blob/master/tutorial/en-us/9-smartContract\cgas\5_minttokens_and_refund.md" class="contribution-link d-block">Improve this Doc</a>
                <div class="side-nav-text">In this article</div>
                <div id="navbar-sidenav">
                    <nav class='nav nav-pills flex-column'>
<a class='ml--2 d-none my-1 nav-link' href='#c3dcc34c'>MintTokens and Refund</a>
<nav class='nav nav-pills flex-column'>
<a class='ml-0 my-1 nav-link' href='#b40b6db7'>Part of the code for MintTokens</a>
<a class='ml-0 my-1 nav-link' href='#d533adaa'>Part of the code for Refund</a>
<a class='ml-0 my-1 nav-link' href='#c7f5ef62'>Next Step</a>
</nav>
</nav>
                </div>
            </div>
        </div>
    </div>
    <div class="lightbulb" title="Turn On/Off" onclick="turnOff()">
        <i class="far fa-lightbulb"></i>
    </div>
    <footer>
        <div class="d-flex justify-content-between py-1 px-3 px-sm-4 px-md-5">
            <ul class="d-none d-md-block">
                <li><a href="https://github.com/neo-project/docs" title="GitHub" target="_blank">GitHub</a></li>
                <li><a href="https://github.com/neo-project/docs/issues" title="Issue" target="_blank">Issue</a></li>
                <li><a href="https://discord.io/neo" title="Discord" target="_blank">Discord</a></li>
            </ul>
            <p>Build by <a href="https://github.com/chenzhitong/NeoDocsBuilder" title="NeoDocsBuilder" target="_blank">NeoDocsBuilder</a></p>
            <p>Licensed under <a href="https://github.com/neo-project/docs/blob/master/LICENSE" title="CC-BY-4.0" target="_blank">CC-BY-4.0</a> license. </p>
        </div>
    </footer>
    <script src="https://neo-cdn.azureedge.net/lib/jquery/jquery.min.js"></script>
    <script src="https://neo-cdn.azureedge.net/lib/popper.js/popper.min.js"></script>
    <script src="https://neo-cdn.azureedge.net/lib/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://neo-cdn.azureedge.net/js/jquery.lazyload.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/highlight.min.js"></script>
    <script src="https://neo-cdn.azureedge.net/js/text-autospace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-130525731-2"></script>
    <script src="/js/site.min.js"></script>
    <script>
        //适用于FAQ的根据标题展开收缩
        if (false) {
            $("h2").click(function (e) {
                $(".div-collapse").not($(e.target).parents("h2").next()).hide("fast");
                $(e.target).parents("h2").next().toggle("fast");
            });
        }
    </script>
</body>
</html>
